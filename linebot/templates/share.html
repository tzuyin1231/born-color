<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è‰²å½©åˆ†æåˆ†äº«</title>
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <script>
        const liffId = "{{ liff_id }}"; // æ›¿æ›ç‚ºä½ çš„ LIFF ID
        
        function getSeasonInfo(analysisResult) {
            const seasonMap = {
                "Spring Light": { color: "#eecfd2", name: "æ·¨æ˜¥å‹" },
                "Summer Light": { color: "#e8aac3", name: "æ·ºå¤å‹" },
                "Spring Bright": { color: "#d6223c", name: "æ·ºæ˜¥å‹" },
                "Summer Mute": { color: "#f0cada", name: "å†·å¤å‹" },
                "Autumn Deep": { color: "#9d1130", name: "æš–ç§‹å‹" },
                "Autumn Mute": { color: "#e79e98", name: "æŸ”ç§‹å‹" },
                "Winter Bright": { color: "#c23b71", name: "æ·¨å†¬å‹" },
                "Winter Dark": { color: "#7e4257", name: "æ·±å†¬å‹" }
            };

            return seasonMap[analysisResult] || { color: "#ff9cc3", name: "æœªçŸ¥é¡å‹" };
        }
        
        document.addEventListener("DOMContentLoaded", function() {
            liff.init({ liffId })
                .then(() => {
                    if (!liff.isLoggedIn()) {
                        liff.login();
                        return;
                    }

                    const urlParams = new URLSearchParams(window.location.search);
                    const analysisResult = urlParams.get("result") || "æœªçŸ¥çµæœ";
                    const imgUrl = decodeURIComponent(decodeURIComponent(urlParams.get("img_url") || ""));
                    const seasonInfo = getSeasonInfo(analysisResult);
                    const analysisResultCh = seasonInfo.name;
                    
                    const resultTextElem = document.getElementById("result-text");

                    // è¨­å®šæ–‡å­—ï¼Œä½¿ç”¨ \n æ›è¡Œ
                    resultTextElem.innerHTML = `æ‚¨çš„è‰²å½©å­£å‹ç‚ºï¼š<br><br>${analysisResultCh}<br>${analysisResult}`;
                    
                    // å­˜å…¥ dataset è®“ shareResult() ä½¿ç”¨
                    resultTextElem.dataset.result = analysisResult;
                    resultTextElem.dataset.resultCh = analysisResultCh;

                    // è¨­å®šæŒ‰éˆ•é¡è‰²
                    document.getElementById("share-button").style.backgroundColor = seasonInfo.color;

                    if (imgUrl) {
                        document.getElementById("result-img").src = imgUrl;
                    }
                })
                .catch(err => console.error("LIFF åˆå§‹åŒ–å¤±æ•—", err));
        });

        function shareResult() {
            if (!liff.isApiAvailable('shareTargetPicker')) {
                alert("ç„¡æ³•ä½¿ç”¨ LINE åˆ†äº«åŠŸèƒ½ï¼Œè«‹æ‰‹å‹•è¤‡è£½é€£çµï¼");
                return;
            }

            const resultTextElem = document.getElementById("result-text");
            const analysisResult = resultTextElem.dataset.result;  // è‹±æ–‡åç¨±
            const analysisResultCh = resultTextElem.dataset.resultCh;  // ä¸­æ–‡åç¨±
            const imgUrl = document.getElementById("result-img").src;
            const seasonInfo = getSeasonInfo(analysisResult);
            const testLink = "https://line.me/R/ti/p/@973wluet";

            const flexMessage = {
                type: "flex",
                altText: "ä¾†çœ‹çœ‹æˆ‘çš„è‰²å½©åˆ†æçµæœï¼",
                contents: {
                    type: "bubble",
                    hero: {
                        type: "image",
                        url: imgUrl,
                        size: "full",
                        aspectRatio: "20:13",
                        backgroundColor: "#faf3f3",
                        aspectMode: "cover"
                    },
                    body: {
                        type: "box",
                        layout: "vertical",
                        backgroundColor: "#faf3f3",
                        contents: [
                            {
                                type: "text",
                                text: "æˆ‘çš„è‰²å½©åˆ†æçµæœ",
                                weight: "bold",
                                size: "xl",
                                align: "center"
                            },
                            {
                                type: "text",
                                text: `ğŸ¨ æˆ‘çš„è‰²å½©å­£å‹ï¼š\n${analysisResultCh}\n${analysisResult}`, // æ›è¡Œé¡¯ç¤ºä¸­æ–‡åç¨±
                                size: "md",
                                wrap: true,
                                align: "center"
                            }
                        ]
                    },
                    footer: {
                        type: "box",
                        layout: "vertical",
                        backgroundColor: "#faf3f3",
                        contents: [
                            {
                                type: "button",
                                style: "primary",
                                action: {
                                    type: "uri",
                                    label: "ä¸€èµ·ä¾†æ¸¬è©¦",
                                    uri: testLink
                                },
                                color: seasonInfo.color
                            }
                        ]
                    }
                }
            };

            liff.shareTargetPicker([flexMessage])
                .then(res => {
                    if (res) {
                        alert("åˆ†äº«æˆåŠŸï¼");
                    } else {
                        alert("åˆ†äº«å–æ¶ˆ");
                    }
                })
                .catch(err => console.error("åˆ†äº«å¤±æ•—", err));
        }
    </script>
</head>
<body style="margin: 0; padding: 0; font-family: 'Arial', sans-serif; background: linear-gradient(135deg, #ffdde1, #ee9ca7); display: flex; justify-content: center; align-items: center; height: 100vh;">
    <div style="background: #faf3f3; padding: 20px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: center; max-width: 400px;">
        <h2 style="color: #d6223c;">è‰²å½©åˆ†æçµæœ</h2>
        <p id="result-text" style="font-size: 18px; font-weight: bold; color: #333;">è¼‰å…¥ä¸­...</p>
        <img id="result-img" src="" alt="è‰²å½©åˆ†æçµæœ" 
             style="max-width: 100%; height: auto; border-radius: 10px; margin-bottom: 15px;" 
             onerror="console.error('åœ–ç‰‡è¼‰å…¥å¤±æ•—:', this.src); this.alt='åœ–ç‰‡è¼‰å…¥å¤±æ•—ï¼';">
        <button id="share-button" onclick="shareResult()" 
                style="background-color: #ff9cc3; color: white; padding: 12px 20px; border: none; border-radius: 5px; font-size: 16px; font-weight: bold; cursor: pointer; transition: 0.3s;">
            åˆ†äº«çµæœ
        </button>
    </div>
</body>

</html>
